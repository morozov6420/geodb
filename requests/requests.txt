-- Запрос №1 вывести всё из таблицы
select
	id_crime as id,
	age_group as age,
	cr_type as type,
	time,
	date,
	st_x(geom) as lng,
	st_y(geom) as lat
from 
	ny_crimes

-- Запрос №2 вывести 5 близжайших соседей к точке
select 
	id_crime as id,
	age_group as age,
	cr_type as type,
	time,
	date,
	st_x(geom) as lng,
	st_y(geom) as lat
from 
	ny_crimes 
order by geom <-> st_makepoint(-74.162627,40.576205) 
limit 5


-- Запрос № 3.01 преступления в полигоне
select st_astext(
  st_multi(
    _______( -- st_convexhull or st_makepolygon
      'LINESTRING(_______)'::geometry
    )
  )
) as text

select 
  id_crime as id,
  age_group as age,
  cr_type as type,
  time,
  date,
  st_x(ny_crimes.geom) as lng, 
  st_y(ny_crimes.geom) as lat
from 
  ny_crimes 
where st_intersects(
  ny_crimes.geom, 
  st_multi(
    _______( -- st_convexhull or st_makepolygon
      'LINESTRING(_______)'::geometry
    )
  )
)


-- Запрос №3 преступления в конкретном районе города
select 
	id_crime as id,
	age_group as age,
	cr_type as type,
	time,
	date,
	st_x(ny_crimes.geom) as lng, 
	st_y(ny_crimes.geom) as lat
from 
	ny_crimes 
join ny_parts on st_intersects(ny_crimes.geom, ny_parts.geom) 
where ny_parts.boroname like'Staten%' 
limit 5

-- Запрос №4 преступления в радиусе 6 км
select
	ny_parts.boroname as region,
	ny_crimes.cr_type as type, 
	st_x(ny_crimes.geom) as lng, 
	st_y(ny_crimes.geom) as lat
from
	ny_crimes
join ny_parts on st_intersects(ny_crimes.geom, ny_parts.geom) 
where
	st_dwithin(ny_parts.geom, st_makepoint(-74.162627, 40.576205)::geography, 6000)


-- Запрос №5 расстояние между преступлениями в метрах 
select 
	st_distance_sphere( 
		(
			select 
				ny_crimes.geom 
			from 
				ny_crimes 
			join ny_parts on st_intersects(ny_crimes.geom, ny_parts.geom) 
			where ny_parts.boroname like 'BROOK%' and id_crime = 2
		), 
		(
			select 
				ny_crimes.geom 
			from 
				ny_crimes
			join ny_parts on st_intersects(ny_crimes.geom, ny_parts.geom) 
			where ny_parts.boroname like 'BROOK%' and id_crime = 7
		), 
		true 
) as dist

-- Запрос №6 расстояния между кластерами
CREATE VIEW brook AS
	select
	c.geom as bro
from ny_crimes c
join ny_parts p on st_intersects(c.geom, p.geom) 
where p.boroname like 'Brook%';

CREATE VIEW queen AS
	select
	c.geom as que
from ny_crimes c
join ny_parts p on st_intersects(c.geom, p.geom) 
where p.boroname like 'Queen%';

select 
	AVG(st_distance_sphere(bro, que)) as UPGMA,
	st_distance_sphere(
		st_point(
			AVG(st_x(bro)), 
			AVG(st_y(bro))
		), 
		st_point(
			AVG(st_x(que)), 
			AVG(st_y(que))
		)
	) as CENTROID,
	MAX(st_distance_sphere(bro, que)) as COMPLETE,
	MIN(st_distance_sphere(bro, que)) as SINGLE
from brook
CROSS JOIN queen;

-- drop view brook;
-- drop view queen;


-- (просто обращаемся к таблице преступления и выводим координаты каждого) 
-- select 
-- 	st_x(geom) as lng,
-- 	st_y(geom) as lat 
-- from 
-- 	ny_crimes 
-- where 
-- 	region = 'STATEN ISLAND' 
-- limit 15